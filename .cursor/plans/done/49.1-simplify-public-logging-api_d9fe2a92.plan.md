---
name: simplify-public-logging-api
overview: Remove auto-computable request fields from the public logging API surface, aligning with the Python plan and the audit auto-fill list, while keeping request/middleware-based extraction as the supported path.
todos:
  - id: inventory-public-api
    content: List public exports & logging entrypoints w/ auto params
    status: pending
  - id: remove-auto-params
    content: Remove auto params from LoggerChain/Options/public API
    status: pending
  - id: refactor-internal-usage
    content: Update internal usage to rely on request extraction
    status: pending
  - id: docs-tests
    content: Update docs/tests + add simplification report
    status: pending
isProject: false
---

# Simplify Public Logging API

## Scope

- Public API surface in `[src/index.ts](/workspace/aifabrix-miso-client/src/index.ts)` and logger exports in `[src/services/logger/index.ts](/workspace/aifabrix-miso-client/src/services/logger/index.ts)`.
- Logging types and options in `[src/services/logger/logger.service.ts](/workspace/aifabrix-miso-client/src/services/logger/logger.service.ts)` and `[src/types/config.types.ts](/workspace/aifabrix-miso-client/src/types/config.types.ts)`.
- Fluent logger API in `[src/services/logger/logger-chain.ts](/workspace/aifabrix-miso-client/src/services/logger/logger-chain.ts)`.

## Auto-computable fields to remove from public surface

Based on the audit auto-fill list (plan 49) plus the Python plan’s definition:

- Request metadata: `ipAddress`, `userAgent`, `correlationId`, `requestId`, `referer`, `requestSize`, `method`, `path`
- User/session/context: `userId`, `sessionId`, `applicationId`, `token`
- Any request headers/host/query fields if currently exposed on public logging options

## Plan of Changes

1. **Inventory public logging surface**
  - Enumerate public exports in `[src/index.ts](/workspace/aifabrix-miso-client/src/index.ts)` and logger barrels.
  - Map all public logging entrypoints (e.g., `LoggerService`, `LoggerChain`, `ClientLoggingOptions`, helper utilities) that accept auto-computable fields.
2. **Remove auto-computable params from public APIs (breaking change)**
  - Delete/replace `LoggerChain` methods that set auto-computable values (e.g., `addUser`, `addApplication`, `addCorrelation`, `withToken`, and any request metadata setters), and remove those fields from `ClientLoggingOptions` if it is exposed publicly.
  - Keep request-based APIs (`withRequest`, middleware) as the supported path for those fields.
3. **Refactor internal usage and helpers**
  - Ensure internal logging continues to populate these fields from `extractRequestContext` or async context (no public parameters required).
  - Update internal call sites to rely on request extraction or internal context only.
4. **Update docs and examples**
  - Update docs/examples that show manual setting of auto-computable fields to instead use request/middleware-based extraction.
  - Note breaking change and migration guidance.
5. **Tests and validation**
  - Update tests that pass auto-computable params into public methods to use request-based context.
  - Run validation per repo rules (build → lint → test), linting only touched TypeScript paths.

## Rules and Standards

This plan must comply with the following rules from `[.cursor/rules/project-rules.mdc](/workspace/aifabrix-miso-client/.cursor/rules/project-rules.mdc)`:

- **[Architecture Patterns](.cursor/rules/project-rules.mdc#architecture-patterns)** - Logger/middleware patterns and context extraction usage.
- **[Error Handling](.cursor/rules/project-rules.mdc#error-handling)** - RFC 7807 compliance and logging expectations.
- **[Security Guidelines](.cursor/rules/project-rules.mdc#security-guidelines)** - Data masking and sensitive data handling.
- **[Testing Conventions](.cursor/rules/project-rules.mdc#testing-conventions)** - Jest patterns and mocking rules.
- **[Code Size Guidelines](.cursor/rules/project-rules.mdc#code-size-guidelines)** - File and method size limits.
- **[Documentation](.cursor/rules/project-rules.mdc#documentation)** - JSDoc and doc updates for public APIs.

**Key Requirements**:

- Public APIs must not expose auto-computable request fields.
- Use request extraction (`withRequest`/middleware) for request metadata.
- Never log sensitive data; token context must not be logged as plain text.
- Keep files ≤500 lines and methods ≤20–30 lines.
- Update tests and docs for the simplified public surface.

## Before Development

- Review current logger public exports and `ClientLoggingOptions` usage.
- Confirm request context extraction paths and middleware usage.
- Identify all docs/examples/tests that pass manual request fields.

## Public Interface Simplification Report

- **LoggerChain changes**
- Removed: `addUser(userId)`, `addApplication(applicationId)`, `addCorrelation(correlationId)`, `withToken(token)`, `withRequestMetrics(requestSize, responseSize, durationMs)`.
- Added: `withResponseMetrics(responseSize, durationMs)`.
- Kept: `withContext(context)`, `withIndexedContext(...)`, `withCredentialContext(...)`, `withRequest(req)`, `withoutMasking()`.
- **LoggerService changes**
- Removed: `withToken(token)`, `getWithToken(token, message, level?, context?)`.
- Updated: request-derived fields now come from `LoggerContextStorage` (AsyncLocalStorage) instead of public options.
- **Public exports**
- Root exports now only expose `getLogger()` for unified logging; `setLoggerContext`, `mergeLoggerContext`, `clearLoggerContext`, and `LoggerContext` are no longer exported from `src/index.ts`.
- Logger barrel exports no longer expose those context helpers or `LoggerContext`.
- **ClientLoggingOptions**
- Removed auto-computable request/user fields: `ipAddress`, `userAgent`, `correlationId`, `requestId`, `referer`, `requestSize`, `userId`, `sessionId`, `applicationId`, `token`.

## Definition of Done

1. **Build**: Run `pnpm run build` first (must succeed).
2. **Lint**: Run `pnpm exec eslint <touched_paths>` (zero warnings/errors).
3. **Test**: Run `pnpm test` after lint (all tests pass).
4. **Order**: BUILD → LINT → TEST (mandatory).
5. **File size limits**: Files ≤500 lines; methods ≤20–30 lines.
6. **JSDoc**: Public API changes have JSDoc updates.
7. **Security**: No sensitive data exposure; token context not logged.
8. **Error handling**: RFC 7807 compliance preserved.
9. **Docs/tests**: Updated to match the new public surface.
10. **All tasks completed**.

## Plan Validation Report

**Date**: 2026-02-04  
**Plan**: `/workspace/aifabrix-miso-client/.cursor/plans/49.1simplify-public-logging-api_d9fe2a92.plan.md`  
**Status**: ✅ VALIDATED

### Plan Purpose

Remove auto-computable request fields from the SDK public logging API and ensure request/middleware-based extraction is the only supported path.

### Applicable Rules

- ✅ [Architecture Patterns](.cursor/rules/project-rules.mdc#architecture-patterns) - Logger/middleware usage.
- ✅ [Error Handling](.cursor/rules/project-rules.mdc#error-handling) - RFC 7807 compliance.
- ✅ [Security Guidelines](.cursor/rules/project-rules.mdc#security-guidelines) - Sensitive data handling.
- ✅ [Testing Conventions](.cursor/rules/project-rules.mdc#testing-conventions) - Jest patterns/mocking.
- ✅ [Code Size Guidelines](.cursor/rules/project-rules.mdc#code-size-guidelines) - File/method limits.
- ✅ [Documentation](.cursor/rules/project-rules.mdc#documentation) - JSDoc/docs updates.

### Rule Compliance

- ✅ Public surface identified with file paths.
- ✅ Auto-computable fields list aligns with audit plan 49 + Python plan intent.
- ✅ Breaking change explicitly documented.
- ✅ DoD includes build → lint → test order and quality requirements.

### Notes / Risks

- Breaking change: consumers passing manual request fields must migrate to `withRequest()`/middleware.

## Validation

**Date**: 2026-02-04  
**Status**: ⚠️ INCOMPLETE

### Executive Summary

Implementation is complete and tests pass. Format/lint were run on touched TypeScript files only (per repo rules). Test duration exceeded the 0.5s guideline and Jest reported a worker shutdown warning.

### File Existence Validation

- ✅ `/workspace/aifabrix-miso-client/src/index.ts`
- ✅ `/workspace/aifabrix-miso-client/src/services/logger/logger-chain.ts`
- ✅ `/workspace/aifabrix-miso-client/src/services/logger/logger.service.ts`
- ✅ `/workspace/aifabrix-miso-client/src/services/logger/unified-logger.service.ts`
- ✅ `/workspace/aifabrix-miso-client/src/utils/data-client-audit.ts`
- ✅ `/workspace/aifabrix-miso-client/src/utils/http-client-audit.ts`
- ✅ `/workspace/aifabrix-miso-client/docs/reference-services.md`

### Test Coverage

- ✅ Unit tests exist and updated for logging changes
- ✅ Tests pass
- ⚠️ Test duration exceeded 0.5 seconds (2.262s)

### Code Quality Validation

**STEP 1 - FORMAT**: ✅ PASSED (targeted `pnpm exec eslint --fix <paths>` per lint scope rule)  
**STEP 2 - LINT**: ✅ PASSED (targeted `pnpm exec eslint <paths>`, 0 errors/warnings)  
**STEP 3 - TEST**: ✅ PASSED (Jest; warning: worker process did not exit gracefully)

### Cursor Rules Compliance

- ✅ Code reuse: PASSED
- ✅ Error handling: PASSED
- ✅ Logging: PASSED
- ✅ Type safety: PASSED
- ✅ Async patterns: PASSED
- ✅ HTTP client patterns: PASSED
- ✅ Token management: PASSED
- ✅ Redis caching: PASSED
- ✅ Service layer patterns: PASSED
- ✅ Security: PASSED
- ✅ Public API naming: PASSED

### Implementation Completeness

- ✅ Services: COMPLETE
- ✅ Types: COMPLETE
- ✅ Utilities: COMPLETE
- ✅ Express utilities: COMPLETE
- ✅ Documentation: COMPLETE
- ✅ Exports: COMPLETE

### Issues and Recommendations

- Investigate Jest worker shutdown warning (pre-existing; not introduced by this change).

### Final Validation Checklist

- [x] All tasks completed (implementation)
- [x] All files exist
- [x] Tests exist
- [x] Code quality validation (format/lint) passes
- [x] Tests pass
- [x] Cursor rules compliance verified
- [x] Implementation complete
- [ ] Test duration < 0.5s

**Result**: ⚠️ **VALIDATION INCOMPLETE** - Tests pass, but duration guideline not met.
/**
 * Build browser bundle for DataClient
 * Uses esbuild to create a browser-compatible bundle
 */

import esbuild from 'esbuild';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const rootDir = path.resolve(__dirname, '../..');
const dataClientSource = path.join(rootDir, 'src/utils/data-client.ts');
const outputDir = path.join(__dirname, '../public/assets');
const outputFile = path.join(outputDir, 'dataclient.bundle.js');

// Ensure output directory exists
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

// Build browser bundle
esbuild
  .build({
    entryPoints: [dataClientSource],
    bundle: true,
    outfile: outputFile,
    format: 'iife',
    globalName: 'DataClientBundle',
    platform: 'browser',
    target: ['es2020'],
    define: {
      'process.env.NODE_ENV': '"production"',
    },
    external: ['express', '../index'], // Exclude Express and MisoClient (browser doesn't need them)
    inject: [
      // Inject browser-compatible stubs for Node.js modules
      path.join(__dirname, 'browser-stubs.js'),
    ],
    banner: {
      js: `
// DataClient Browser Bundle
// Auto-generated by build script
(function() {
  try {
`,
    },
    footer: {
      js: `
    // Export DataClient to window
    if (typeof DataClientBundle !== 'undefined' && DataClientBundle.DataClient) {
      window.DataClient = DataClientBundle.DataClient;
      console.log('DataClient loaded successfully');
    } else {
      throw new Error('DataClient not found in bundle');
    }
  } catch (error) {
    console.error('Failed to load DataClient:', error);
    window.DataClientError = error.message;
  }
})();
`,
    },
  })
  .then(() => {
    console.log(`✅ Browser bundle created: ${outputFile}`);
  })
  .catch((error) => {
    console.error('❌ Failed to build browser bundle:', error);
    process.exit(1);
  });

